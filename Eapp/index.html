<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>å°çº¢ä¹¦ç®¡ç†å¹³å° - æ¡Œé¢ç‰ˆ</title>
  <style>
    :root {
      --primary: #ff2442;
      --primary-light: #ff6b7a;
      --secondary: #333;
      --success: #52c41a;
      --warning: #faad14;
      --error: #ff4d4f;
      --bg: #f5f5f5;
      --card-bg: #ffffff;
      --text: #333;
      --text-light: #666;
      --border: #e8e8e8;
      --shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    .header {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: var(--shadow);
      text-align: center;
    }

    .header h1 {
      color: var(--primary);
      font-size: 28px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .header p {
      color: var(--text-light);
      font-size: 14px;
    }

    .session-bar {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 24px;
      box-shadow: var(--shadow);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      flex-wrap: wrap;
    }

    .session-controls {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .mode-toggle {
      display: flex;
      align-items: center;
    }

    .toggle-label {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      font-size: 14px;
      color: var(--text);
    }

    .toggle-label input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: var(--primary);
    }

    .toggle-text {
      font-weight: 500;
    }

    .session-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .session-label {
      font-weight: 500;
      color: var(--text);
    }

    .session-select {
      padding: 8px 12px;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: var(--card-bg);
      font-size: 14px;
      min-width: 200px;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover {
      background: var(--primary-light);
      transform: translateY(-1px);
    }

    .btn-secondary {
      background: var(--secondary);
      color: white;
    }

    .btn-secondary:hover {
      background: #555;
      transform: translateY(-1px);
    }

    .btn-success {
      background: var(--success);
      color: white;
    }

    .btn-success:hover {
      background: #389e0d;
      transform: translateY(-1px);
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 24px;
      margin-bottom: 24px;
    }

    .card {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 24px;
      box-shadow: var(--shadow);
      transition: transform 0.3s ease;
    }

    .card:hover {
      transform: translateY(-2px);
    }

    .card-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 16px;
      color: var(--text);
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-label {
      display: block;
      font-weight: 500;
      margin-bottom: 8px;
      color: var(--text);
    }

    .form-input {
      width: 100%;
      padding: 12px;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 14px;
      transition: border-color 0.3s ease;
    }

    .form-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(255, 36, 66, 0.1);
    }

    .form-textarea {
      min-height: 100px;
      resize: vertical;
    }

    .status-indicator {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
    }

    .status-online {
      background: rgba(82, 196, 26, 0.1);
      color: var(--success);
    }

    .status-offline {
      background: rgba(255, 77, 79, 0.1);
      color: var(--error);
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }

    .status-online .status-dot {
      background: var(--success);
    }

    .status-offline .status-dot {
      background: var(--error);
    }

    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 16px 20px;
      border-radius: 8px;
      color: white;
      font-weight: 500;
      z-index: 1000;
      transform: translateX(400px);
      transition: transform 0.3s ease;
    }

    .notification.show {
      transform: translateX(0);
    }

    .notification.success {
      background: var(--success);
    }

    .notification.error {
      background: var(--error);
    }

    .notification.warning {
      background: var(--warning);
    }

    .notification.info {
      background: var(--primary);
    }

    .content-list {
      max-height: 400px;
      overflow-y: auto;
    }

    .content-item {
      padding: 16px;
      border: 1px solid var(--border);
      border-radius: 8px;
      margin-bottom: 12px;
      background: var(--card-bg);
      transition: all 0.3s ease;
    }

    .content-item:hover {
      border-color: var(--primary);
      box-shadow: 0 2px 8px rgba(255, 36, 66, 0.1);
    }

    .content-item:last-child {
      margin-bottom: 0;
    }

    .content-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .content-type-badge {
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 500;
      text-transform: uppercase;
    }

    .content-type-badge.video {
      background: rgba(255, 36, 66, 0.1);
      color: var(--primary);
    }

    .content-type-badge.image {
      background: rgba(82, 196, 26, 0.1);
      color: var(--success);
    }

    .content-id {
      font-size: 11px;
      color: var(--text-light);
      font-family: monospace;
    }

    .content-title {
      font-weight: 600;
      margin-bottom: 12px;
      color: var(--text);
      line-height: 1.4;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .content-author {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
    }

    .author-avatar {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      object-fit: cover;
    }

    .author-name {
      font-size: 13px;
      color: var(--text-light);
      font-weight: 500;
    }

    .content-cover {
      margin-bottom: 12px;
      border-radius: 6px;
      overflow: hidden;
    }

    .cover-image {
      width: 100%;
      max-height: 200px;
      object-fit: cover;
      border-radius: 6px;
    }

    .content-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 12px;
      color: var(--text-light);
    }

    .interaction-stats {
      display: flex;
      gap: 12px;
    }

    .stat-item {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .content-dimensions {
      font-family: monospace;
      font-size: 11px;
    }

    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid #f3f3f3;
      border-top: 2px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .hidden {
      display: none;
    }

    .image-upload {
      border: 2px dashed var(--border);
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: border-color 0.3s ease;
    }

    .image-upload:hover {
      border-color: var(--primary);
    }

    .image-upload.dragover {
      border-color: var(--primary);
      background: rgba(255, 36, 66, 0.05);
    }

    .image-preview {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      gap: 12px;
      margin-top: 16px;
    }

    .image-item {
      position: relative;
      aspect-ratio: 1;
      border-radius: 8px;
      overflow: hidden;
      background: var(--bg);
    }

    .image-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

     .image-remove {
       position: absolute;
       top: 4px;
       right: 4px;
       width: 20px;
       height: 20px;
       background: var(--error);
       color: white;
       border: none;
       border-radius: 50%;
       font-size: 12px;
       cursor: pointer;
       display: flex;
       align-items: center;
       justify-content: center;
     }

     .image-info {
       position: absolute;
       bottom: 0;
       left: 0;
       right: 0;
       background: rgba(0,0,0,0.7);
       color: white;
       padding: 4px 8px;
       font-size: 12px;
       text-align: center;
       white-space: nowrap;
       overflow: hidden;
       text-overflow: ellipsis;
     }

     .image-path {
       position: absolute;
       bottom: 20px;
       left: 4px;
       right: 4px;
       background: rgba(0,0,0,0.8);
       color: white;
       padding: 2px 4px;
       font-size: 10px;
       border-radius: 2px;
       word-break: break-all;
       max-height: 30px;
       overflow: hidden;
     }

     .quick-path-btn {
       padding: 4px 8px;
       border: 1px solid var(--border);
       border-radius: 4px;
       background: var(--card-bg);
       color: var(--text);
       font-size: 11px;
       cursor: pointer;
       transition: all 0.2s ease;
     }

     .quick-path-btn:hover {
       background: var(--primary);
       color: white;
       border-color: var(--primary);
     }

    @media (max-width: 768px) {
      .container {
        padding: 16px;
      }
      
      .session-bar {
        flex-direction: column;
        align-items: stretch;
      }
      
      .grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- å¤´éƒ¨ -->
    <div class="header">
      <h1>ğŸ“± å°çº¢ä¹¦ç®¡ç†å¹³å°</h1>
      <p>è½»æ¾ç®¡ç†ä½ çš„å°çº¢ä¹¦å†…å®¹ï¼Œä¸€é”®å‘å¸ƒï¼Œæ™ºèƒ½åˆ†æ</p>
    </div>

    <!-- ä¼šè¯ç®¡ç† -->
    <div class="session-bar">
      <div class="session-info">
        <span class="session-label">å½“å‰ä¼šè¯ï¼š</span>
        <select id="sessionSelect" class="session-select">
          <option value="">è¯·é€‰æ‹©ä¼šè¯</option>
        </select>
        <button id="refreshSessions" class="btn btn-secondary">ğŸ”„ åˆ·æ–°</button>
        <button id="addAccount" class="btn btn-success">â• æ·»åŠ è´¦å·</button>
      </div>
      <div class="session-controls">
        <div id="loginStatus" class="status-indicator status-offline">
          <span class="status-dot"></span>
          <span>æœªç™»å½•</span>
        </div>
        <div class="mode-toggle">
          <label class="toggle-label">
            <input type="checkbox" id="headlessMode" checked>
            <span class="toggle-text">æ— å¤´æ¨¡å¼</span>
          </label>
        </div>
        <button id="checkLogin" class="btn btn-primary">ğŸ” æ£€æŸ¥ç™»å½•çŠ¶æ€</button>
      </div>
    </div>

    <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
    <div class="grid">
      <!-- å‘å¸ƒå†…å®¹ -->
      <div class="card">
        <h3 class="card-title">ğŸ“ å‘å¸ƒæ–°å†…å®¹</h3>
        <form id="publishForm">
          <div class="form-group">
            <label class="form-label">æ ‡é¢˜</label>
            <input type="text" id="title" class="form-input" placeholder="è¾“å…¥å¸å¼•äººçš„æ ‡é¢˜..." maxlength="20">
          </div>
          <div class="form-group">
            <label class="form-label">å†…å®¹</label>
            <textarea id="content" class="form-input form-textarea" placeholder="åˆ†äº«ä½ çš„ç²¾å½©å†…å®¹..."></textarea>
          </div>
           <div class="form-group">
             <label class="form-label">å›¾ç‰‡</label>
             <div class="form-group" style="margin-bottom: 12px;">
               <label class="form-label" style="font-size: 13px; margin-bottom: 6px;">å›¾ç‰‡å®Œæ•´è·¯å¾„</label>
               <div style="display: flex; gap: 8px; margin-bottom: 4px;">
                 <input type="text" id="imagePrefix" class="form-input" placeholder="ä¾‹å¦‚: C:\Users\ç”¨æˆ·å\Downloads\å‘å¸ƒç´ æ\" 
                        style="font-size: 13px; padding: 8px; flex: 1;">
                 <button type="button" id="autoFillPrefix" class="btn btn-secondary" style="padding: 8px 12px; font-size: 12px;">
                   ğŸ” è‡ªåŠ¨æ£€æµ‹
                 </button>
                 <button type="button" id="selectFolder" class="btn btn-secondary" style="padding: 8px 12px; font-size: 12px;">
                   ğŸ“ é€‰æ‹©æ–‡ä»¶å¤¹
                 </button>
               </div>
               <div style="display: flex; gap: 8px; margin-bottom: 4px;">
                 <input type="text" id="usernameInput" class="form-input" placeholder="æ‰‹åŠ¨è¾“å…¥ç”¨æˆ·åï¼ˆå¯é€‰ï¼‰" 
                        style="font-size: 13px; padding: 8px; flex: 1;">
                 <button type="button" id="setUsername" class="btn btn-secondary" style="padding: 8px 12px; font-size: 12px;">
                   ğŸ‘¤ è®¾ç½®ç”¨æˆ·å
                 </button>
               </div>
               <div style="font-size: 11px; color: var(--text-light); margin-bottom: 4px;">
                 è¾“å…¥å›¾ç‰‡æ–‡ä»¶å¤¹çš„å®Œæ•´è·¯å¾„ï¼Œç¨‹åºä¼šè‡ªåŠ¨æ‹¼æ¥æ–‡ä»¶åã€‚ç¤ºä¾‹: C:\Users\ç”¨æˆ·å\Downloads\å‘å¸ƒç´ æ\
               </div>
               <div id="quickPaths" style="display: flex; gap: 6px; flex-wrap: wrap; margin-top: 4px;">
                 <button type="button" class="quick-path-btn" data-path="user-downloads-material">ç”¨æˆ·ä¸‹è½½/å‘å¸ƒç´ æ/</button>
                 <button type="button" class="quick-path-btn" data-path="user-downloads">ç”¨æˆ·ä¸‹è½½/</button>
                 <button type="button" class="quick-path-btn" data-path="user-pictures">ç”¨æˆ·å›¾ç‰‡/</button>
                 <button type="button" class="quick-path-btn" data-path="D:\images\">D:\images\</button>
                 <button type="button" class="quick-path-btn" data-path="./images/">./images/</button>
               </div>
             </div>
             <div class="image-upload" id="imageUpload">
               <div>ğŸ“· ç‚¹å‡»é€‰æ‹©å›¾ç‰‡æˆ–æ‹–æ‹½åˆ°æ­¤å¤„</div>
               <div style="font-size: 12px; color: var(--text-light); margin-top: 8px;">
                 æ”¯æŒ JPGã€PNGã€GIF æ ¼å¼<br>
                 <strong>æŒ‰ä½ Ctrl é”®ç‚¹å‡»å¯é€‰æ‹©æ•´ä¸ªæ–‡ä»¶å¤¹ï¼ˆè‡ªåŠ¨æå–è·¯å¾„å‰ç¼€ï¼‰</strong>
               </div>
             </div>
             <div style="display: flex; gap: 8px; margin-top: 8px;">
               <button type="button" id="selectImageBtn" class="btn btn-secondary" style="flex: 1; padding: 8px 12px; font-size: 12px;">
                 ğŸ“· é€‰æ‹©å›¾ç‰‡æ–‡ä»¶
               </button>
               <button type="button" id="selectFolderBtn" class="btn btn-primary" style="flex: 1; padding: 8px 12px; font-size: 12px;">
                 ğŸ“ é€‰æ‹©å›¾ç‰‡æ–‡ä»¶å¤¹ï¼ˆæ¨èï¼‰
               </button>
             </div>
             <input type="file" id="imageInput" multiple accept="image/*" style="display: none;">
             <input type="file" id="folderInput" webkitdirectory multiple style="display: none;">
             <div class="image-preview" id="imagePreview"></div>
             <div id="imagePathsList" class="image-paths-list" style="margin-top: 12px; padding: 12px; background: var(--bg); border-radius: 6px; font-size: 12px; display: none;">
               <div style="font-weight: 500; margin-bottom: 8px; color: var(--text);">ğŸ“ å°†è¦ä¸Šä¼ çš„å›¾ç‰‡è·¯å¾„ï¼š</div>
               <div id="imagePathsContent" style="font-family: monospace; color: var(--text-light); line-height: 1.4;"></div>
             </div>
           </div>
          <button type="submit" class="btn btn-primary" style="width: 100%;">
            <span id="publishText">ğŸš€ å‘å¸ƒå†…å®¹</span>
            <span id="publishLoading" class="loading hidden"></span>
          </button>
        </form>
      </div>

      <!-- å†…å®¹ç®¡ç† -->
      <div class="card">
        <h3 class="card-title">ğŸ“‹ æˆ‘çš„å†…å®¹</h3>
        <div style="margin-bottom: 16px;">
          <button id="loadContent" class="btn btn-success">ğŸ“¥ åŠ è½½å†…å®¹åˆ—è¡¨</button>
        </div>
        <div class="content-list" id="contentList">
          <div style="text-align: center; color: var(--text-light); padding: 40px 20px;">
            ç‚¹å‡»"åŠ è½½å†…å®¹åˆ—è¡¨"æŸ¥çœ‹ä½ çš„å‘å¸ƒå†…å®¹
          </div>
        </div>
      </div>
    </div>

    <!-- æœç´¢åŠŸèƒ½ -->
    <div class="card">
      <h3 class="card-title">ğŸ” æœç´¢å†…å®¹</h3>
      <div style="display: flex; gap: 12px; margin-bottom: 16px;">
        <input type="text" id="searchKeyword" class="form-input" placeholder=
        "è¾“å…¥æœç´¢å…³é”®è¯..." style="flex: 1;">
        <button id="searchContent" class="btn btn-secondary">ğŸ” æœç´¢</button>
      </div>
      <div class="content-list" id="searchResults">
        <div style="text-align: center; color: var(--text-light); padding: 40px 20px;">
          è¾“å…¥å…³é”®è¯å¼€å§‹æœç´¢
        </div>
      </div>
    </div>

    <!-- æµè§ˆå™¨ç®¡ç† -->
    <div class="card">
      <h3 class="card-title">ğŸŒ æµè§ˆå™¨ç®¡ç†</h3>
      <div style="display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap;">
        <button id="browserStatusBtn" class="btn btn-secondary">ğŸ“Š æŸ¥çœ‹çŠ¶æ€</button>
        <button id="closeBrowserBtn" class="btn btn-warning">âŒ å…³é—­å½“å‰æµè§ˆå™¨</button>
        <button id="closeAllBrowsersBtn" class="btn btn-danger">ğŸ—‘ï¸ å…³é—­æ‰€æœ‰æµè§ˆå™¨</button>
      </div>
      <div id="browserStatus" class="browser-status" style="background: var(--bg-light); padding: 16px; border-radius: 8px; font-family: monospace; font-size: 14px; display: none;">
        <div style="text-align: center; color: var(--text-light);">
          ç‚¹å‡»"æŸ¥çœ‹çŠ¶æ€"è·å–æµè§ˆå™¨ä¿¡æ¯
        </div>
      </div>
    </div>
  </div>

  <!-- é€šçŸ¥ç»„ä»¶ -->
  <div id="notification" class="notification"></div>

  <script>
    // ç­‰å¾…DOMåŠ è½½å®Œæˆ
    document.addEventListener('DOMContentLoaded', function() {
      // å…¨å±€å˜é‡
      let currentSession = '';
      let selectedImages = [];

      // DOM å…ƒç´ 
      const $ = (id) => document.getElementById(id);
      const sessionSelect = $('sessionSelect');
      const loginStatus = $('loginStatus');
      const checkLoginBtn = $('checkLogin');
      const refreshSessionsBtn = $('refreshSessions');
      const addAccountBtn = $('addAccount');
      const headlessMode = $('headlessMode');
      const publishForm = $('publishForm');
       const imageUpload = $('imageUpload');
       const imageInput = $('imageInput');
       const folderInput = $('folderInput');
       const imagePreview = $('imagePreview');
       const selectImageBtn = $('selectImageBtn');
       const selectFolderBtn = $('selectFolderBtn');
       const imagePrefix = $('imagePrefix');
       const imagePathsList = $('imagePathsList');
       const imagePathsContent = $('imagePathsContent');
       const autoFillPrefix = $('autoFillPrefix');
       const selectFolder = $('selectFolder');
       const usernameInput = $('usernameInput');
       const setUsername = $('setUsername');
       const quickPaths = document.querySelectorAll('.quick-path-btn');
      const loadContentBtn = $('loadContent');
      const contentList = $('contentList');
      const searchKeyword = $('searchKeyword');
      const searchContentBtn = $('searchContent');
      const searchResults = $('searchResults');
      const notification = $('notification');

      // è°ƒè¯•ï¼šæ£€æŸ¥å…ƒç´ æ˜¯å¦æ­£ç¡®è·å–
      console.log('DOM elements loaded:', {
        sessionSelect,
        checkLoginBtn,
        refreshSessionsBtn,
        publishForm,
        loadContentBtn,
        searchContentBtn
      });

      // æµ‹è¯•æŒ‰é’®ç‚¹å‡»
      if (checkLoginBtn) {
        console.log('Check login button found:', checkLoginBtn);
      } else {
        console.error('Check login button NOT found');
        console.log('Available elements:', document.querySelectorAll('button'));
      }
      
      // æ£€æŸ¥æ‰€æœ‰æŒ‰é’®å…ƒç´ 
      const allButtons = document.querySelectorAll('button');
      console.log('All buttons found:', allButtons.length);
      allButtons.forEach((btn, index) => {
        console.log(`Button ${index}:`, btn.id, btn.textContent);
      });

    // å·¥å…·å‡½æ•°
    function showNotification(message, type = 'info', duration = 3000) {
      notification.textContent = message;
      notification.className = `notification ${type}`;
      notification.classList.add('show');
      
      setTimeout(() => {
        notification.classList.remove('show');
      }, duration);
    }

    function setLoading(element, loading) {
      if (!element) {
        console.error('setLoading: element is null');
        return;
      }
      
      const text = element.querySelector('span:not(.loading)');
      const loadingEl = element.querySelector('.loading');
      
      if (loading) {
        if (text) text.classList.add('hidden');
        if (loadingEl) loadingEl.classList.remove('hidden');
        element.disabled = true;
        
        // å¦‚æœæ²¡æœ‰loadingå…ƒç´ ï¼Œæ˜¾ç¤ºç®€å•çš„åŠ è½½çŠ¶æ€
        if (!loadingEl) {
          element.textContent = 'åŠ è½½ä¸­...';
        }
      } else {
        if (text) text.classList.remove('hidden');
        if (loadingEl) loadingEl.classList.add('hidden');
        element.disabled = false;
        
        // å¦‚æœæ²¡æœ‰loadingå…ƒç´ ï¼Œæ¢å¤åŸå§‹æ–‡æœ¬
        if (!loadingEl) {
          // æ ¹æ®æŒ‰é’®IDæ¢å¤åŸå§‹æ–‡æœ¬
          if (element.id === 'checkLogin') {
            element.textContent = 'ğŸ” æ£€æŸ¥ç™»å½•çŠ¶æ€';
          } else if (element.id === 'loadContent') {
            element.textContent = 'ğŸ“¥ åŠ è½½å†…å®¹åˆ—è¡¨';
          } else if (element.id === 'searchContent') {
            element.textContent = 'ğŸ” æœç´¢';
          } else if (element.id === 'refreshSessions') {
            element.textContent = 'ğŸ”„ åˆ·æ–°';
          }
        }
      }
    }

    function updateLoginStatus(isLoggedIn) {
      if (isLoggedIn) {
        loginStatus.className = 'status-indicator status-online';
        loginStatus.innerHTML = '<span class="status-dot"></span><span>å·²ç™»å½•</span>';
      } else {
        loginStatus.className = 'status-indicator status-offline';
        loginStatus.innerHTML = '<span class="status-dot"></span><span>æœªç™»å½•</span>';
      }
    }

    function getHeaders() {
      const headers = {
        'Content-Type': 'application/json'
      };
      
      if (currentSession) {
        headers['Mcp-Session-Id'] = currentSession;
      }
      
      // æ·»åŠ æ— å¤´æ¨¡å¼è®¾ç½®
      headers['Mcp-Headless'] = headlessMode.checked ? 'true' : 'false';
      
      return headers;
    }

    // API è°ƒç”¨å‡½æ•°
    async function apiCall(endpoint, method = 'GET', body = null) {
      // åŠ¨æ€è·å–å½“å‰é¡µé¢çš„ç«¯å£
      const currentPort = window.location.port || '18060';
      const url = `http://localhost:${currentPort}${endpoint}`;
      const options = {
        method,
        headers: getHeaders()
      };
      
      if (body) {
        options.body = JSON.stringify(body);
      }
      
      const response = await fetch(url, options);
      const data = await response.json();
      
      // æ£€æŸ¥HTTPçŠ¶æ€ç 
      if (!response.ok) {
        // å¦‚æœHTTPçŠ¶æ€ç ä¸æ˜¯2xxï¼ŒæŠ›å‡ºé”™è¯¯
        const error = new Error(data.error || `HTTP ${response.status}: ${response.statusText}`);
        error.data = data;
        throw error;
      }
      
      return data;
    }

    // æ·»åŠ è´¦å·åŠŸèƒ½
    async function addAccount() {
      try {
        // æ‰“å¼€æ–°çª—å£è¿›è¡Œç™»å½•
        const loginWindow = window.open('login.html', '_blank', 'width=500,height=700');
        
        if (!loginWindow) {
          showNotification('æ— æ³•æ‰“å¼€ç™»å½•çª—å£ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨å¼¹çª—è®¾ç½®', 'warning');
          return;
        }
        
        showNotification('ğŸš€ æ­£åœ¨æ‰“å¼€ç™»å½•çª—å£ï¼Œå°†è‡ªåŠ¨æ‰§è¡Œç™»å½•æµç¨‹...', 'info', 3000);
        
        // ç›‘å¬çª—å£å…³é—­
        const checkClosed = setInterval(() => {
          if (loginWindow.closed) {
            clearInterval(checkClosed);
            showNotification('ç™»å½•çª—å£å·²å…³é—­ï¼Œæ­£åœ¨åˆ·æ–°ä¼šè¯åˆ—è¡¨...', 'info');
            // è‡ªåŠ¨åˆ·æ–°ä¼šè¯åˆ—è¡¨
            setTimeout(() => {
              loadSessions();
              showNotification('âœ… ä¼šè¯åˆ—è¡¨å·²åˆ·æ–°ï¼Œè¯·é€‰æ‹©æ–°æ·»åŠ çš„è´¦å·', 'success');
            }, 1000);
          }
        }, 1000);
        
        // å®šæœŸæ£€æŸ¥ç™»å½•çŠ¶æ€ï¼ˆå¯é€‰ï¼‰
        const checkLogin = setInterval(() => {
          if (loginWindow.closed) {
            clearInterval(checkLogin);
            return;
          }
          
          // æ¯5ç§’æ£€æŸ¥ä¸€æ¬¡ä¼šè¯åˆ—è¡¨æ˜¯å¦æœ‰æ›´æ–°
          setTimeout(() => {
            loadSessions();
          }, 5000);
        }, 10000);
        
      } catch (error) {
        showNotification('æ‰“å¼€ç™»å½•çª—å£å¤±è´¥', 'error');
      }
    }

    // ä¼šè¯ç®¡ç†
    async function loadSessions() {
      try {
        const data = await apiCall('/api/v1/sessions');
        sessionSelect.innerHTML = '<option value="">è¯·é€‰æ‹©ä¼šè¯</option>';
        
        if (data.data && data.data.sessions) {
          data.data.sessions.forEach(session => {
            const option = document.createElement('option');
            option.value = session;
            option.textContent = session;
            sessionSelect.appendChild(option);
          });
        }
      } catch (error) {
        showNotification('åŠ è½½ä¼šè¯åˆ—è¡¨å¤±è´¥', 'error');
      }
    }

    // æ£€æŸ¥ç™»å½•çŠ¶æ€
    async function checkLoginStatus() {
      if (!currentSession) {
        showNotification('è¯·å…ˆé€‰æ‹©ä¼šè¯', 'warning');
        return;
      }
      
      setLoading(checkLoginBtn, true);
      
      try {
        const data = await apiCall('/api/v1/login/status');
        const isLoggedIn = data.data;
        
        updateLoginStatus(isLoggedIn);
        
        if (isLoggedIn) {
          showNotification('ç™»å½•çŠ¶æ€æ­£å¸¸', 'success');
        } else {
          showNotification('æœªç™»å½•ï¼Œè¯·é‡æ–°ç™»å½•', 'warning');
        }
      } catch (error) {
        showNotification('æ£€æŸ¥ç™»å½•çŠ¶æ€å¤±è´¥', 'error');
        updateLoginStatus(false);
      } finally {
        setLoading(checkLoginBtn, false);
      }
    }

     // å›¾ç‰‡ä¸Šä¼ å¤„ç†
     function setupImageUpload() {
       imageUpload.addEventListener('click', (e) => {
         // å¦‚æœæŒ‰ä½Ctrlé”®ï¼Œé€‰æ‹©æ–‡ä»¶å¤¹
         if (e.ctrlKey || e.metaKey) {
           folderInput.click();
         } else {
           imageInput.click();
         }
       });

       imageUpload.addEventListener('dragover', (e) => {
         e.preventDefault();
         imageUpload.classList.add('dragover');
       });

       imageUpload.addEventListener('dragleave', () => {
         imageUpload.classList.remove('dragover');
       });

       imageUpload.addEventListener('drop', (e) => {
         e.preventDefault();
         imageUpload.classList.remove('dragover');
         
         const files = Array.from(e.dataTransfer.files);
         handleImageFiles(files);
       });

       imageInput.addEventListener('change', (e) => {
         const files = Array.from(e.target.files);
         handleImageFiles(files);
       });

       // æ–‡ä»¶å¤¹é€‰æ‹©å¤„ç†
       folderInput.addEventListener('change', (e) => {
         const files = Array.from(e.target.files);
         if (files.length > 0) {
           // ä»ç¬¬ä¸€ä¸ªæ–‡ä»¶æå–ç›®å½•è·¯å¾„
           const firstFile = files[0];
           if (firstFile.webkitRelativePath) {
             const fullPath = firstFile.webkitRelativePath;
             const lastSlashIndex = fullPath.lastIndexOf('/');
             if (lastSlashIndex > 0) {
               const directory = fullPath.substring(0, lastSlashIndex + 1);
               imagePrefix.value = directory;
               updateImagePaths();
               showNotification(`å·²è‡ªåŠ¨æå–ç›®å½•å‰ç¼€: ${directory}`, 'success');
               
               // ä¿å­˜åˆ°localStorage
               localStorage.setItem('xiaohongshu_image_prefix', directory);
             }
           }
           
           // è¿‡æ»¤å‡ºå›¾ç‰‡æ–‡ä»¶
           const imageFiles = files.filter(file => file.type.startsWith('image/'));
           if (imageFiles.length > 0) {
             handleImageFiles(imageFiles);
             showNotification(`å·²é€‰æ‹© ${imageFiles.length} å¼ å›¾ç‰‡`, 'success');
           } else {
             showNotification('é€‰æ‹©çš„æ–‡ä»¶å¤¹ä¸­æ²¡æœ‰å›¾ç‰‡æ–‡ä»¶', 'warning');
           }
         }
       });
     }

     function handleImageFiles(files) {
       files.forEach(file => {
         if (file.type.startsWith('image/')) {
           const reader = new FileReader();
           reader.onload = (e) => {
             const imageItem = document.createElement('div');
             imageItem.className = 'image-item';
             
             // å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡é€‰æ‹©å›¾ç‰‡ä¸”æ²¡æœ‰è®¾ç½®è·¯å¾„ï¼Œæç¤ºç”¨æˆ·ä½¿ç”¨æ–‡ä»¶å¤¹é€‰æ‹©
             if (selectedImages.length === 0 && !imagePrefix.value.trim()) {
               showNotification('å»ºè®®æŒ‰ä½ Ctrl é”®ç‚¹å‡»é€‰æ‹©æ•´ä¸ªæ–‡ä»¶å¤¹ï¼Œå¯è‡ªåŠ¨æå–è·¯å¾„å‰ç¼€', 'info');
             }
             
             // ç”Ÿæˆå®Œæ•´è·¯å¾„
             const fullPath = generateImagePath(file.name);
             
             imageItem.innerHTML = `
               <img src="${e.target.result}" alt="${file.name}">
               <div class="image-info">${file.name}</div>
               <div class="image-path" style="position: absolute; bottom: 20px; left: 4px; right: 4px; background: rgba(0,0,0,0.8); color: white; padding: 2px 4px; font-size: 10px; border-radius: 2px; word-break: break-all;">${fullPath}</div>
               <button type="button" class="image-remove" onclick="removeImage(this)">Ã—</button>
             `;
             imagePreview.appendChild(imageItem);
             
             selectedImages.push({
               file: file,
               element: imageItem,
               fullPath: fullPath
             });
             
             // æ›´æ–°è·¯å¾„åˆ—è¡¨æ˜¾ç¤º
             updateImagePathsList();
           };
           reader.readAsDataURL(file);
         }
       });
     }

     // ä»æ–‡ä»¶è·¯å¾„ä¸­æå–ç›®å½•å‰ç¼€
     function extractDirectoryPrefix(file) {
       // å°è¯•ä»æ–‡ä»¶çš„webkitRelativePathè·å–å®Œæ•´è·¯å¾„
       if (file.webkitRelativePath) {
         const fullPath = file.webkitRelativePath;
         const lastSlashIndex = fullPath.lastIndexOf('/');
         if (lastSlashIndex > 0) {
           const directory = fullPath.substring(0, lastSlashIndex + 1);
           imagePrefix.value = directory;
           updateImagePaths();
           showNotification(`å·²è‡ªåŠ¨æå–ç›®å½•å‰ç¼€: ${directory}`, 'success');
           return;
         }
       }
       
       // å°è¯•ä»æ–‡ä»¶è·¯å¾„ä¸­æå–ç›®å½•ï¼ˆå¦‚æœæµè§ˆå™¨æ”¯æŒï¼‰
       if (file.path) {
         const fullPath = file.path;
         const lastSlashIndex = Math.max(fullPath.lastIndexOf('/'), fullPath.lastIndexOf('\\'));
         if (lastSlashIndex > 0) {
           const directory = fullPath.substring(0, lastSlashIndex + 1);
           imagePrefix.value = directory;
           updateImagePaths();
           showNotification(`å·²è‡ªåŠ¨æå–ç›®å½•å‰ç¼€: ${directory}`, 'success');
           return;
         }
       }
       
       // å¦‚æœæ— æ³•è·å–å®Œæ•´è·¯å¾„ï¼Œå°è¯•ä½¿ç”¨é»˜è®¤è·¯å¾„
       if (!imagePrefix.value.trim()) {
         const defaultPath = './images/';
         imagePrefix.value = defaultPath;
         updateImagePaths();
         showNotification(`å·²è®¾ç½®é»˜è®¤ç›®å½•å‰ç¼€: ${defaultPath}`, 'info');
       }
     }

     // ç”Ÿæˆå›¾ç‰‡å®Œæ•´è·¯å¾„
     function generateImagePath(fileName) {
       const prefix = imagePrefix.value.trim();
       
       if (!prefix) {
         // å¦‚æœæ²¡æœ‰å‰ç¼€ï¼Œè¿”å›æ–‡ä»¶å
         return fileName;
       }
       
       // ç¡®ä¿å‰ç¼€ä»¥è·¯å¾„åˆ†éš”ç¬¦ç»“å°¾
       let normalizedPrefix = prefix;
       if (!normalizedPrefix.endsWith('/') && !normalizedPrefix.endsWith('\\')) {
         // æ ¹æ®å‰ç¼€ä¸­çš„åˆ†éš”ç¬¦ç±»å‹å†³å®šä½¿ç”¨å“ªä¸ª
         if (normalizedPrefix.includes('\\')) {
           normalizedPrefix += '\\';
         } else {
           normalizedPrefix += '/';
         }
       }
       
       return normalizedPrefix + fileName;
     }

    function removeImage(button) {
      const imageItem = button.parentElement;
      const index = Array.from(imagePreview.children).indexOf(imageItem);
      
      if (index > -1) {
        selectedImages.splice(index, 1);
        imageItem.remove();
        
        // æ›´æ–°è·¯å¾„åˆ—è¡¨æ˜¾ç¤º
        updateImagePathsList();
      }
    }

    // å‘å¸ƒå†…å®¹
    async function publishContent(title, content) {
      if (!currentSession) {
        showNotification('è¯·å…ˆé€‰æ‹©ä¼šè¯', 'warning');
        return;
      }

      if (!title.trim()) {
        showNotification('è¯·è¾“å…¥æ ‡é¢˜', 'warning');
        return;
      }

      if (!content.trim()) {
        showNotification('è¯·è¾“å…¥å†…å®¹', 'warning');
        return;
      }

      if (selectedImages.length === 0) {
        showNotification('è¯·è‡³å°‘é€‰æ‹©ä¸€å¼ å›¾ç‰‡', 'warning');
        return;
      }

      const publishBtn = $('publishText').parentElement;
      setLoading(publishBtn, true);

       try {
         // ä½¿ç”¨å®Œæ•´è·¯å¾„
         const imagePaths = selectedImages.map((img) => {
           // ä¼˜å…ˆä½¿ç”¨å®Œæ•´è·¯å¾„
           if (img.fullPath) {
             return img.fullPath;
           }
           // å›é€€åˆ°æ–‡ä»¶å
           if (img.file && img.file.name) {
             return img.file.name;
           }
           // æœ€åå›é€€åˆ°é»˜è®¤åç§°
           return `image_${Date.now()}_${Math.random().toString(36).substr(2, 9)}.jpg`;
         });
        
        const data = await apiCall('/api/v1/publish', 'POST', {
          title: title.trim(),
          content: content.trim(),
          images: imagePaths
        });

        // å‘å¸ƒæˆåŠŸ
        showNotification('å†…å®¹å‘å¸ƒæˆåŠŸï¼', 'success');
        
         // æ¸…ç©ºè¡¨å•
         publishForm.reset();
         selectedImages = [];
         imagePreview.innerHTML = '';
         imagePathsList.style.display = 'none';
        
      } catch (error) {
        // å¤„ç†APIé”™è¯¯
        let errorMsg = 'å‘å¸ƒå¤±è´¥';
        
        if (error.data) {
          // APIè¿”å›çš„è¯¦ç»†é”™è¯¯ä¿¡æ¯
          errorMsg = error.data.details || error.data.error || error.message;
        } else {
          // ç½‘ç»œé”™è¯¯æˆ–å…¶ä»–å¼‚å¸¸
          errorMsg = error.message || 'ç½‘ç»œé”™è¯¯';
        }
        
        showNotification(`å‘å¸ƒå¤±è´¥: ${errorMsg}`, 'error');
      } finally {
        setLoading(publishBtn, false);
      }
    }

    // åŠ è½½å†…å®¹åˆ—è¡¨
    async function loadContentList() {
      if (!currentSession) {
        showNotification('è¯·å…ˆé€‰æ‹©ä¼šè¯', 'warning');
        return;
      }

      setLoading(loadContentBtn, true);

      try {
        const data = await apiCall('/api/v1/feeds/list');
        
        if (data.data && data.data.feeds) {
          renderContentList(data.data.feeds, contentList);
          showNotification(`åŠ è½½äº† ${data.data.feeds.length} æ¡å†…å®¹`, 'success');
        } else {
          contentList.innerHTML = '<div style="text-align: center; color: var(--text-light); padding: 40px 20px;">æš‚æ— å†…å®¹</div>';
        }
      } catch (error) {
        showNotification('åŠ è½½å†…å®¹å¤±è´¥', 'error');
        contentList.innerHTML = '<div style="text-align: center; color: var(--error); padding: 40px 20px;">åŠ è½½å¤±è´¥</div>';
      } finally {
        setLoading(loadContentBtn, false);
      }
    }

    // æœç´¢å†…å®¹
    async function searchContent(keyword) {
      if (!currentSession) {
        showNotification('è¯·å…ˆé€‰æ‹©ä¼šè¯', 'warning');
        return;
      }

      if (!keyword.trim()) {
        showNotification('è¯·è¾“å…¥æœç´¢å…³é”®è¯', 'warning');
        return;
      }

      setLoading(searchContentBtn, true);

      try {
        const data = await apiCall(`/api/v1/feeds/search?keyword=${encodeURIComponent(keyword)}`);
        
        if (data.data && data.data.feeds) {
          renderContentList(data.data.feeds, searchResults);
          showNotification(`æ‰¾åˆ° ${data.data.feeds.length} æ¡ç›¸å…³å†…å®¹`, 'success');
        } else {
          searchResults.innerHTML = '<div style="text-align: center; color: var(--text-light); padding: 40px 20px;">æœªæ‰¾åˆ°ç›¸å…³å†…å®¹</div>';
        }
      } catch (error) {
        showNotification('æœç´¢å¤±è´¥', 'error');
        searchResults.innerHTML = '<div style="text-align: center; color: var(--error); padding: 40px 20px;">æœç´¢å¤±è´¥</div>';
      } finally {
        setLoading(searchContentBtn, false);
      }
    }

    // æ¸²æŸ“å†…å®¹åˆ—è¡¨
    function renderContentList(feeds, container) {
      if (!feeds || feeds.length === 0) {
        container.innerHTML = '<div style="text-align: center; color: var(--text-light); padding: 40px 20px;">æš‚æ— å†…å®¹</div>';
        return;
      }

      container.innerHTML = feeds.map(feed => {
        // è§£æå°çº¢ä¹¦æ•°æ®æ ¼å¼
        const noteCard = feed.noteCard || {};
        const user = noteCard.user || {};
        const interactInfo = noteCard.interactInfo || {};
        const cover = noteCard.cover || {};
        
        // è·³è¿‡æ— æ•ˆæ•°æ®ï¼ˆå¦‚ rec_query ç±»å‹ï¼‰
        if (feed.modelType === 'rec_query' || !noteCard.type) {
          return `
            <div class="content-item" style="opacity: 0.6;">
              <div class="content-header">
                <div class="content-type-badge" style="background: rgba(128, 128, 128, 0.1); color: #666;">æ¨è</div>
                <div class="content-id">ID: ${feed.id || 'æœªçŸ¥'}</div>
              </div>
              <div class="content-title">æ¨èå†…å®¹ï¼ˆæš‚ä¸æ”¯æŒæ˜¾ç¤ºï¼‰</div>
            </div>
          `;
        }
        
        // è·å–å°é¢å›¾ç‰‡
        const coverImage = cover.urlDefault || cover.urlPre || '';
        
        // è·å–å†…å®¹ç±»å‹
        const contentType = noteCard.type === 'video' ? 'è§†é¢‘' : 'å›¾æ–‡';
        
        // è·å–äº’åŠ¨æ•°æ®
        const likedCount = interactInfo.likedCount || '0';
        const commentCount = interactInfo.commentCount || '0';
        const collectedCount = interactInfo.collectedCount || '0';
        
        // å¤„ç†æ ‡é¢˜æ˜¾ç¤º
        const displayTitle = noteCard.displayTitle && noteCard.displayTitle.trim() 
          ? noteCard.displayTitle.trim() 
          : 'æ— æ ‡é¢˜';
        
        // å¤„ç†ç”¨æˆ·ä¿¡æ¯
        const userName = user.nickname || user.nickName || 'æœªçŸ¥ç”¨æˆ·';
        const userAvatar = user.avatar || '';
        
        return `
          <div class="content-item">
            <div class="content-header">
              <div class="content-type-badge ${noteCard.type === 'video' ? 'video' : 'image'}">${contentType}</div>
              <div class="content-id">ID: ${feed.id || 'æœªçŸ¥'}</div>
            </div>
            
            <div class="content-title">${displayTitle}</div>
            
            <div class="content-author">
              ${userAvatar ? `<img src="${userAvatar}" alt="å¤´åƒ" class="author-avatar" onerror="this.style.display='none'">` : ''}
              <span class="author-name">${userName}</span>
            </div>
            
            ${coverImage ? `
              <div class="content-cover">
                <img src="${coverImage}" alt="å°é¢" class="cover-image" onerror="this.style.display='none'">
              </div>
            ` : ''}
            
            <div class="content-meta">
              <div class="interaction-stats">
                <span class="stat-item">â¤ï¸ ${likedCount}</span>
                <span class="stat-item">ğŸ’¬ ${commentCount}</span>
                <span class="stat-item">â­ ${collectedCount}</span>
              </div>
              <div class="content-dimensions">
                ${cover.width && cover.height ? `${cover.width} Ã— ${cover.height}` : ''}
                ${noteCard.video && noteCard.video.capa ? `Â· ${noteCard.video.capa.duration}ç§’` : ''}
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    // äº‹ä»¶ç›‘å¬
    sessionSelect.addEventListener('change', (e) => {
      currentSession = e.target.value;
      console.log('Session changed to:', currentSession);
      if (currentSession) {
        checkLoginStatus();
      }
    });

    refreshSessionsBtn.addEventListener('click', () => {
      console.log('Refresh sessions clicked');
      loadSessions();
    });
    
    addAccountBtn.addEventListener('click', () => {
      console.log('Add account clicked');
      addAccount();
    });
    
    checkLoginBtn.addEventListener('click', () => {
      console.log('Check login clicked');
      checkLoginStatus();
    });
    
    loadContentBtn.addEventListener('click', () => {
      console.log('Load content clicked');
      loadContentList();
    });
    
    searchContentBtn.addEventListener('click', () => {
      console.log('Search content clicked');
      searchContent(searchKeyword.value);
    });

    publishForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const title = $('title').value;
      const content = $('content').value;
      publishContent(title, content);
    });

    searchKeyword.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        searchContent(searchKeyword.value);
      }
    });

       // ç›‘å¬å‰ç¼€ç›®å½•å˜åŒ–ï¼Œè‡ªåŠ¨æ›´æ–°å›¾ç‰‡è·¯å¾„
       imagePrefix.addEventListener('input', () => {
         updateImagePaths();
         // ä¿å­˜åˆ°localStorage
         localStorage.setItem('xiaohongshu_image_prefix', imagePrefix.value);
       });

       // è‡ªåŠ¨æ£€æµ‹å½“å‰ç›®å½•
       autoFillPrefix.addEventListener('click', () => {
         // è·å–å½“å‰ç”¨æˆ·å
         const currentUser = getCurrentUsername();
         
         // å°è¯•æ£€æµ‹å¸¸è§çš„å›¾ç‰‡ç›®å½•
         const commonPaths = [
           `C:\\Users\\${currentUser}\\Downloads\\å‘å¸ƒç´ æ\\`,
           `C:\\Users\\${currentUser}\\Downloads\\`,
           `C:\\Users\\${currentUser}\\Pictures\\`,
           'D:\\images\\',
           './images/',
           './assets/',
           './uploads/'
         ];
         
         // ä½¿ç”¨ç¬¬ä¸€ä¸ªè·¯å¾„ä½œä¸ºé»˜è®¤å€¼
         const detectedPath = commonPaths[0];
         imagePrefix.value = detectedPath;
         updateImagePaths();
         showNotification(`å·²è‡ªåŠ¨å¡«å…¥è·¯å¾„: ${detectedPath}`, 'success');
       });

       // é€‰æ‹©æ–‡ä»¶å¤¹ï¼ˆä½¿ç”¨æ–‡ä»¶è¾“å…¥æ¡†æ¨¡æ‹Ÿï¼‰
       selectFolder.addEventListener('click', () => {
         const folderInput = document.createElement('input');
         folderInput.type = 'file';
         folderInput.webkitdirectory = true;
         folderInput.multiple = true;
         
         folderInput.addEventListener('change', (e) => {
           if (e.target.files.length > 0) {
             const firstFile = e.target.files[0];
             const fullPath = firstFile.webkitRelativePath || firstFile.name;
             const folderPath = fullPath.substring(0, fullPath.lastIndexOf('/') + 1);
             
             // è½¬æ¢ä¸ºç»å¯¹è·¯å¾„æ ¼å¼
             let normalizedPath = folderPath;
             if (normalizedPath.startsWith('./')) {
               // ç›¸å¯¹è·¯å¾„ï¼Œä¿æŒåŸæ ·
             } else {
               // å°è¯•è½¬æ¢ä¸ºWindowsæ ¼å¼
               normalizedPath = normalizedPath.replace(/\//g, '\\');
             }
             
             imagePrefix.value = normalizedPath;
             updateImagePaths();
             showNotification(`å·²é€‰æ‹©æ–‡ä»¶å¤¹: ${normalizedPath}`, 'success');
             
             // ä¿å­˜åˆ°localStorage
             localStorage.setItem('xiaohongshu_image_prefix', normalizedPath);
           }
         });
         
         folderInput.click();
       });

       // è®¾ç½®ç”¨æˆ·å
       setUsername.addEventListener('click', () => {
         const username = usernameInput.value.trim();
         if (username) {
           localStorage.setItem('xiaohongshu_username', username);
           showNotification(`ç”¨æˆ·åå·²è®¾ç½®ä¸º: ${username}`, 'success');
           // é‡æ–°ç”Ÿæˆè·¯å¾„
           updateImagePaths();
         } else {
           showNotification('è¯·è¾“å…¥ç”¨æˆ·å', 'warning');
         }
       });

       // å¿«é€Ÿè·¯å¾„æŒ‰é’®
       quickPaths.forEach(btn => {
         btn.addEventListener('click', () => {
           const pathKey = btn.getAttribute('data-path');
           const currentUser = getCurrentUsername();
           let path = '';
           
           switch (pathKey) {
             case 'user-downloads-material':
               path = `C:\\Users\\${currentUser}\\Downloads\\å‘å¸ƒç´ æ\\`;
               break;
             case 'user-downloads':
               path = `C:\\Users\\${currentUser}\\Downloads\\`;
               break;
             case 'user-pictures':
               path = `C:\\Users\\${currentUser}\\Pictures\\`;
               break;
             default:
               path = pathKey;
           }
           
           imagePrefix.value = path;
           updateImagePaths();
           showNotification(`å·²é€‰æ‹©è·¯å¾„: ${path}`, 'info');
         });
       });

       // æ›´æ–°æ‰€æœ‰å·²é€‰æ‹©å›¾ç‰‡çš„è·¯å¾„
       function updateImagePaths() {
         selectedImages.forEach((img, index) => {
           if (img.file && img.element) {
             const newPath = generateImagePath(img.file.name);
             img.fullPath = newPath;
             
             // æ›´æ–°æ˜¾ç¤ºçš„è·¯å¾„
             const pathElement = img.element.querySelector('.image-path');
             if (pathElement) {
               pathElement.textContent = newPath;
             }
           }
         });
         
         // æ›´æ–°è·¯å¾„åˆ—è¡¨æ˜¾ç¤º
         updateImagePathsList();
       }

       // æ›´æ–°å›¾ç‰‡è·¯å¾„åˆ—è¡¨æ˜¾ç¤º
       function updateImagePathsList() {
         if (selectedImages.length === 0) {
           imagePathsList.style.display = 'none';
           return;
         }

         imagePathsList.style.display = 'block';
         imagePathsContent.innerHTML = selectedImages.map((img, index) => {
           const path = img.fullPath || img.file?.name || `å›¾ç‰‡${index + 1}`;
           return `<div>${index + 1}. ${path}</div>`;
         }).join('');
       }

       // åˆå§‹åŒ–
       setupImageUpload();
       loadSessions();
       
       // å›¾ç‰‡é€‰æ‹©æŒ‰é’®äº‹ä»¶
       selectImageBtn.addEventListener('click', () => {
         imageInput.click();
       });
       
       selectFolderBtn.addEventListener('click', () => {
         folderInput.click();
       });
       
       // å°è¯•è‡ªåŠ¨å¡«å…¥é»˜è®¤è·¯å¾„
       autoFillDefaultPath();
       
       // æ˜¾ç¤ºå½“å‰ç”¨æˆ·å
       const currentUser = getCurrentUsername();
       if (currentUser !== 'ç”¨æˆ·å') {
         usernameInput.placeholder = `å½“å‰ç”¨æˆ·å: ${currentUser}`;
       }

       // è·å–å½“å‰ç”¨æˆ·å
       function getCurrentUsername() {
         // å°è¯•ä»localStorageè·å–ä¿å­˜çš„ç”¨æˆ·å
         let username = localStorage.getItem('xiaohongshu_username');
         if (username) {
           return username;
         }
         
         // å°è¯•ä»User-Agentä¸­æå–ç”¨æˆ·åï¼ˆWindowsç³»ç»Ÿï¼‰
         const userAgent = navigator.userAgent;
         if (userAgent.includes('Windows')) {
           // å°è¯•ä»User-Agentä¸­æå–ç”¨æˆ·å
           const match = userAgent.match(/Windows NT [\d.]+; ([^;]+)/);
           if (match && match[1]) {
             username = match[1].trim();
             // ä¿å­˜åˆ°localStorage
             localStorage.setItem('xiaohongshu_username', username);
             return username;
           }
         }
         
         // å¦‚æœæ— æ³•è·å–ï¼Œä½¿ç”¨é»˜è®¤å€¼
         username = 'ç”¨æˆ·å';
         localStorage.setItem('xiaohongshu_username', username);
         return username;
       }

       // è‡ªåŠ¨å¡«å…¥é»˜è®¤è·¯å¾„
       function autoFillDefaultPath() {
         // æ£€æŸ¥localStorageä¸­æ˜¯å¦æœ‰ä¿å­˜çš„è·¯å¾„
         const savedPath = localStorage.getItem('xiaohongshu_image_prefix');
         if (savedPath) {
           imagePrefix.value = savedPath;
           updateImagePaths();
           return;
         }
         
         // è·å–å½“å‰ç”¨æˆ·å
         const currentUser = getCurrentUsername();
         
         // å°è¯•æ£€æµ‹å¸¸è§çš„å›¾ç‰‡ç›®å½•
         const commonPaths = [
           `C:\\Users\\${currentUser}\\Downloads\\å‘å¸ƒç´ æ\\`,
           `C:\\Users\\${currentUser}\\Downloads\\`,
           `C:\\Users\\${currentUser}\\Pictures\\`,
           'D:\\images\\',
           './images/',
           './assets/',
           './uploads/'
         ];
         
         // é»˜è®¤ä½¿ç”¨ç¬¬ä¸€ä¸ªè·¯å¾„
         const defaultPath = commonPaths[0];
         imagePrefix.value = defaultPath;
         updateImagePaths();
         
         // ä¿å­˜åˆ°localStorage
         localStorage.setItem('xiaohongshu_image_prefix', defaultPath);
       }

    // æµè§ˆå™¨ç®¡ç†åŠŸèƒ½
    const browserStatusBtn = $('browserStatusBtn');
    const closeBrowserBtn = $('closeBrowserBtn');
    const closeAllBrowsersBtn = $('closeAllBrowsersBtn');
    const browserStatus = $('browserStatus');

    // æŸ¥çœ‹æµè§ˆå™¨çŠ¶æ€
    browserStatusBtn.addEventListener('click', async () => {
      setLoading(browserStatusBtn, true);
      
      try {
        const data = await apiCall('/api/v1/browser/status');
        browserStatus.style.display = 'block';
        browserStatus.innerHTML = `
          <div style="margin-bottom: 8px;"><strong>ğŸŒ æµè§ˆå™¨çŠ¶æ€</strong></div>
          <div>æ— å¤´æ¨¡å¼: <span style="color: ${data.data.headless_mode ? 'var(--success)' : 'var(--warning)'}">${data.data.headless_mode ? 'æ˜¯' : 'å¦'}</span></div>
          <div>æ´»è·ƒä¼šè¯æ•°: <span style="color: var(--primary)">${data.data.session_count}</span></div>
          <div>å½“å‰ä¼šè¯: <span style="color: var(--info)">${currentSession || 'æœªé€‰æ‹©'}</span></div>
        `;
        showNotification('æµè§ˆå™¨çŠ¶æ€è·å–æˆåŠŸ', 'success');
      } catch (error) {
        showNotification('è·å–æµè§ˆå™¨çŠ¶æ€å¤±è´¥', 'error');
        browserStatus.style.display = 'none';
      } finally {
        setLoading(browserStatusBtn, false);
      }
    });

    // å…³é—­å½“å‰æµè§ˆå™¨
    closeBrowserBtn.addEventListener('click', async () => {
      if (!currentSession) {
        showNotification('è¯·å…ˆé€‰æ‹©ä¼šè¯', 'warning');
        return;
      }

      if (!confirm(`ç¡®å®šè¦å…³é—­ä¼šè¯ "${currentSession}" çš„æµè§ˆå™¨å—ï¼Ÿ`)) {
        return;
      }

      setLoading(closeBrowserBtn, true);
      
      try {
        await apiCall('/api/v1/browser/close', 'POST', {
          session_id: currentSession
        });
        showNotification('æµè§ˆå™¨å·²å…³é—­', 'success');
        browserStatus.style.display = 'none';
      } catch (error) {
        showNotification('å…³é—­æµè§ˆå™¨å¤±è´¥', 'error');
      } finally {
        setLoading(closeBrowserBtn, false);
      }
    });

    // å…³é—­æ‰€æœ‰æµè§ˆå™¨
    closeAllBrowsersBtn.addEventListener('click', async () => {
      if (!confirm('ç¡®å®šè¦å…³é—­æ‰€æœ‰æµè§ˆå™¨å—ï¼Ÿè¿™å°†å½±å“æ‰€æœ‰ä¼šè¯ï¼')) {
        return;
      }

      setLoading(closeAllBrowsersBtn, true);
      
      try {
        const data = await apiCall('/api/v1/browser/close-all', 'POST');
        showNotification(`å·²å…³é—­ ${data.data.closed_count} ä¸ªæµè§ˆå™¨`, 'success');
        browserStatus.style.display = 'none';
      } catch (error) {
        showNotification('å…³é—­æ‰€æœ‰æµè§ˆå™¨å¤±è´¥', 'error');
      } finally {
        setLoading(closeAllBrowsersBtn, false);
      }
    });

    // å…¨å±€å‡½æ•°ï¼ˆç”¨äºå›¾ç‰‡åˆ é™¤ï¼‰
    window.removeImage = removeImage;
  });
  </script>

  <!-- Electron ç‰¹å®šåŠŸèƒ½ -->
  <script>
    // æ£€æµ‹æ˜¯å¦åœ¨Electronç¯å¢ƒä¸­
    const isElectron = typeof window.electronAPI !== 'undefined';
    
    if (isElectron) {
      console.log('è¿è¡Œåœ¨Electronç¯å¢ƒä¸­');
      
      // è·å–åº”ç”¨ä¿¡æ¯
      const appInfo = window.electronAPI.getAppInfo();
      console.log('åº”ç”¨ä¿¡æ¯:', appInfo);
      
      // æ·»åŠ Electronç‰¹å®šçš„UIå…ƒç´ 
      document.addEventListener('DOMContentLoaded', function() {
        // åœ¨æ ‡é¢˜æ æ·»åŠ Electronæ ‡è¯†
        const header = document.querySelector('.header h1');
        if (header) {
          header.textContent = 'å°çº¢ä¹¦ç®¡ç†å¹³å° - æ¡Œé¢ç‰ˆ';
        }
        
        // æ·»åŠ åç«¯çŠ¶æ€æŒ‡ç¤ºå™¨
        addBackendStatusIndicator();
        
        // ç›‘å¬åç«¯çŠ¶æ€å˜åŒ–
        window.addEventListener('backend-status-changed', function(event) {
          updateBackendStatus(event.detail);
        });
      });
      
      // æ·»åŠ åç«¯çŠ¶æ€æŒ‡ç¤ºå™¨
      function addBackendStatusIndicator() {
        const sessionBar = document.querySelector('.session-bar');
        if (sessionBar) {
          const statusIndicator = document.createElement('div');
          statusIndicator.id = 'backend-status';
          statusIndicator.style.cssText = `
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: var(--success);
            color: white;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
          `;
          statusIndicator.innerHTML = `
            <div style="width: 8px; height: 8px; background: white; border-radius: 50%;"></div>
            åç«¯æœåŠ¡è¿è¡Œä¸­
          `;
          sessionBar.appendChild(statusIndicator);
        }
      }
      
      // æ›´æ–°åç«¯çŠ¶æ€
      function updateBackendStatus(status) {
        const indicator = document.getElementById('backend-status');
        if (indicator) {
          if (status === 'running') {
            indicator.style.background = 'var(--success)';
            indicator.innerHTML = `
              <div style="width: 8px; height: 8px; background: white; border-radius: 50%;"></div>
              åç«¯æœåŠ¡è¿è¡Œä¸­
            `;
          } else if (status === 'stopped') {
            indicator.style.background = 'var(--error)';
            indicator.innerHTML = `
              <div style="width: 8px; height: 8px; background: white; border-radius: 50%;"></div>
              åç«¯æœåŠ¡å·²åœæ­¢
            `;
          } else {
            indicator.style.background = 'var(--warning)';
            indicator.innerHTML = `
              <div style="width: 8px; height: 8px; background: white; border-radius: 50%;"></div>
              åç«¯æœåŠ¡çŠ¶æ€æœªçŸ¥
            `;
          }
        }
      }
      
      // å¢å¼ºæ–‡ä»¶é€‰æ‹©åŠŸèƒ½
      function enhanceFileSelection() {
        const selectImageBtn = document.getElementById('selectImageBtn');
        const selectFolderBtn = document.getElementById('selectFolderBtn');
        
        if (selectImageBtn && window.electronAPI) {
          selectImageBtn.addEventListener('click', async function() {
            try {
              const result = await window.electronAPI.selectFile({
                title: 'é€‰æ‹©å›¾ç‰‡æ–‡ä»¶',
                filters: [
                  { name: 'å›¾ç‰‡æ–‡ä»¶', extensions: ['jpg', 'jpeg', 'png', 'gif'] },
                  { name: 'æ‰€æœ‰æ–‡ä»¶', extensions: ['*'] }
                ],
                properties: ['openFile', 'multiSelections']
              });
              
              if (result && result.length > 0) {
                // å¤„ç†é€‰æ‹©çš„æ–‡ä»¶
                handleSelectedFiles(result);
              }
            } catch (error) {
              console.error('æ–‡ä»¶é€‰æ‹©å¤±è´¥:', error);
            }
          });
        }
        
        if (selectFolderBtn && window.electronAPI) {
          selectFolderBtn.addEventListener('click', async function() {
            try {
              const result = await window.electronAPI.selectFolder();
              if (result) {
                console.log('é€‰æ‹©çš„æ–‡ä»¶å¤¹:', result);
                // å¤„ç†é€‰æ‹©çš„æ–‡ä»¶å¤¹
                handleSelectedFolder(result);
              }
            } catch (error) {
              console.error('æ–‡ä»¶å¤¹é€‰æ‹©å¤±è´¥:', error);
            }
          });
        }
      }
      
      // å¤„ç†é€‰æ‹©çš„æ–‡ä»¶
      function handleSelectedFiles(files) {
        files.forEach(file => {
          // æ·»åŠ åˆ°å›¾ç‰‡åˆ—è¡¨
          if (typeof handleImageFiles === 'function') {
            // æ¨¡æ‹ŸFileå¯¹è±¡
            const mockFile = {
              name: file.split(/[\\/]/).pop(),
              path: file,
              type: 'image/' + file.split('.').pop().toLowerCase()
            };
            handleImageFiles([mockFile]);
          }
        });
      }
      
      // å¤„ç†é€‰æ‹©çš„æ–‡ä»¶å¤¹
      function handleSelectedFolder(folderPath) {
        // è®¾ç½®å›¾ç‰‡ç›®å½•å‰ç¼€
        const imagePrefix = document.getElementById('imagePrefix');
        if (imagePrefix) {
          imagePrefix.value = folderPath + (folderPath.endsWith('/') || folderPath.endsWith('\\') ? '' : '/');
          updateImagePaths();
        }
      }
      
      // é¡µé¢åŠ è½½å®Œæˆåå¢å¼ºåŠŸèƒ½
      document.addEventListener('DOMContentLoaded', function() {
        enhanceFileSelection();
      });
    } else {
      console.log('è¿è¡Œåœ¨æµè§ˆå™¨ç¯å¢ƒä¸­');
    }
  </script>
</body>
</html>
